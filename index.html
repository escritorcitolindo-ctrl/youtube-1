<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TOEFL KIDS Academy - Mary's Journey</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --p: #4e73df; --s: #f6c23e; --acc: #1cc88a; --err: #e74a3b; --bg: #f8f9fc; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg); padding: 20px; color: #5a5c69; }
        .container { max-width: 800px; margin: auto; background: white; border-radius: 30px; border: 6px solid var(--p); padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .header { text-align: center; border-bottom: 5px solid var(--s); margin-bottom: 30px; padding-bottom: 10px; }
        .section { display: none; } .active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .btn { padding: 15px 30px; border-radius: 50px; border: none; font-weight: 800; cursor: pointer; text-transform: uppercase; margin: 10px 5px; transition: 0.3s; }
        .btn-video { background: var(--err); color: white; box-shadow: 0 4px 0 #b02a1e; }
        .btn-check { background: var(--p); color: white; box-shadow: 0 4px 0 #2e59d9; }
        .btn-next { background: var(--acc); color: white; box-shadow: 0 4px 0 #169b6b; display: none; }
        .btn-teacher { background: #000; color: var(--s); width: 100%; border: 2px solid var(--s); margin-top: 20px; }
        .feedback { background: #f0f4ff; padding: 20px; border-radius: 15px; border-left: 10px solid var(--p); margin: 20px 0; display: none; }
        .flash-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 20px 0; }
        .card { height: 120px; perspective: 1000px; cursor: pointer; }
        .card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; }
        .card.flipped .card-inner { transform: rotateY(180deg); }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 15px; display: flex; align-items: center; justify-content: center; text-align: center; padding: 10px; font-weight: bold; font-size: 0.8rem; border: 2px solid #ddd; }
        .card-front { background: var(--p); color: white; }
        .card-back { background: var(--s); color: black; transform: rotateY(180deg); flex-direction: column; }
        .matching-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .drag-item { padding: 15px; background: white; border: 2px solid var(--p); border-radius: 10px; cursor: grab; text-align: center; font-weight: bold; }
        .drop-zone { padding: 15px; background: #f8f9fc; border: 2px dashed #ccc; border-radius: 10px; text-align: center; min-height: 50px; display: flex; align-items: center; justify-content: center; }
        .drop-zone.correct { background: var(--acc) !important; color: white; border-style: solid; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; border-radius: 10px; overflow: hidden; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        th { background: var(--p); color: white; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>TOEFL Kids Academy üèÜ</h1>
        <p>Lesson: Mary and the Angel Gabriel</p>
    </div>

    <div id="step0" class="section active">
        <h2 style="text-align:center">üé¨ Step 1: Watch the Story</h2>
        <div style="text-align:center; padding: 40px;">
            <p>Please watch the video to start the exam!</p>
            <button class="btn btn-video" onclick="watchVideo()">üì∫ WATCH VIDEO HERE</button><br><br>
            <button id="next0" class="btn btn-next" onclick="move(1)">START EXAM ‚û°Ô∏è</button>
        </div>
    </div>

    <div id="step1" class="section">
        <h2>üé¥ Activity 1: Key Vocabulary</h2>
        <p>Click and flip **ALL 8 cards** to continue.</p>
        <div class="flash-grid" id="flash-area"></div>
        <div id="fb1" class="feedback"></div>
        <button class="btn btn-check" onclick="evalFlash()">CHECK ACTIVITY</button>
        <button id="next1" class="btn btn-next" onclick="move(2)">NEXT GAME ‚û°Ô∏è</button>
    </div>

    <div id="step2" class="section">
        <h2>‚ùì Activity 2: Comprehension Quiz</h2>
        <div id="quiz-area"></div>
        <div id="fb2" class="feedback"></div>
        <button class="btn btn-check" onclick="evalQuiz()">CHECK ANSWERS</button>
        <button id="next2" class="btn btn-next" onclick="move(3)">NEXT GAME ‚û°Ô∏è</button>
    </div>

    <div id="step3" class="section">
        <h2>üîó Activity 3: Matching Game</h2>
        <p>Drag the words to their correct meaning.</p>
        <div class="matching-grid" id="match-area"></div>
        <div id="fb3" class="feedback"></div>
        <button class="btn btn-check" onclick="evalMatch()">CHECK MATCHES</button>
        <button id="next3" class="btn btn-next" onclick="move(4)">NEXT GAME ‚û°Ô∏è</button>
    </div>

    <div id="step4" class="section">
        <h2>üìù Activity 4: Writing Summary</h2>
        <p>Write 4 simple sentences about Mary and the Angel:</p>
        <textarea id="write-text" style="width:100%; height:120px; border-radius:15px; padding:15px; border:2px solid #ddd; font-family: inherit;" placeholder="Mary lived in..."></textarea>
        <div id="fb4" class="feedback"></div>
        <button class="btn btn-check" onclick="evalWriting()">EVALUATE WRITING</button>
        <button id="next4" class="btn btn-next" onclick="move(5)">NEXT GAME ‚û°Ô∏è</button>
    </div>

    <div id="step5" class="section">
        <h2>üó£Ô∏è Activity 5: Speaking Task</h2>
        <p>Read the script aloud for 30 seconds:</p>
        <div style="background:#fff3cd; padding:20px; border-radius:15px; border: 2px dashed #f6c23e; margin-bottom:15px; font-style: italic;">
            "Mary lived in Nazareth. One day, the Angel Gabriel visited her. He said: Do not be afraid, Mary. You will have a special baby named Jesus. Mary is happy to obey God's plan."
        </div>
        <h1 id="timer" style="text-align:center; color:var(--err); font-size: 3rem; margin: 10px 0;">30</h1>
        <button id="spkBtn" class="btn btn-video" style="width:100%" onclick="startSpeak()">üéôÔ∏è START SPEAKING</button>
        <div id="fb5" class="feedback"></div>
        <button id="next5" class="btn btn-next" onclick="move('final')">GET FINAL SCORE üèÅ</button>
    </div>

    <div id="stepfinal" class="section">
        <h2 style="text-align:center">üèÜ FINAL REPORT</h2>
        <div id="final-stats" style="text-align:center; margin-bottom: 20px;"></div>
        
        <div style="background:#eef2f7; padding:25px; border-radius:20px; text-align:center">
            <h3>Register your name:</h3>
            <input type="text" id="stdName" style="width:80%; padding:15px; border-radius:10px; border:1px solid #ccc; font-size:1.1rem" placeholder="Full Name">
            <br><br>
            <button class="btn btn-check" onclick="saveToCloud()">üíæ GUARDAR EN LISTADO GENERAL</button>
        </div>

        <button class="btn btn-teacher" onclick="toggleCloudList()">üìã MIRAR TODOS LOS PARTICIPANTES (LISTADO GENERAL)</button>
        
        <div id="cloud-registry" style="display:none; margin-top:20px;">
            <p id="loading-msg">Cargando datos globales...</p>
            <table id="master-table">
                <thead><tr><th>Student Name</th><th>Final Grade</th><th>Date</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const API_URL = 'https://sheetdb.io/api/v1/mlieo3t3bxthz'; // <--- ¬°TU C√ìDIGO YA EST√Å AQU√ç!

    let scores = {s1:0, s2:0, s3:0, s4:0, s5:0}, cards = new Set(), finalAvg = 0;
    const flashData = [{f:"Nazareth", b:"The town of Mary"},{f:"Gabriel", b:"The Messenger Angel"},{f:"Be afraid", b:"No tengas miedo"},{f:"Jesus", b:"The special baby"},{f:"Well", b:"Place for water"},{f:"Servant", b:"God's helper"},{f:"Happy", b:"Feeling of Mary"},{f:"Plan", b:"God's idea"}];
    const quizData = [{q:"Where did Mary live?", o:["Rome","Nazareth","Paris"], a:1},{q:"Who visited Mary?", o:["A King","The Angel","A Shepherd"], a:1},{q:"What is the baby's name?", o:["Peter","Paul","Jesus"], a:2},{q:"How did Mary feel?", o:["Sad","Angry","Surprised/Happy"], a:2}];
    const matchData = [{w:"Angel", m:"Gabriel"},{w:"Town", m:"Nazareth"},{w:"Baby", m:"Jesus"},{w:"Book", m:"Bible"}];

    function watchVideo() { window.open('https://www.youtube.com/watch?v=RdMjQssEw3A'); document.getElementById('next0').style.display='inline-block'; confetti(); }
    
    function move(s) {
        document.querySelectorAll('.section').forEach(x=>x.classList.remove('active'));
        if(s==='final') { document.getElementById('stepfinal').classList.add('active'); renderFinal(); }
        else { document.getElementById('step'+s).classList.add('active'); initStep(s); }
    }

    function initStep(s) {
        if(s==1) document.getElementById('flash-area').innerHTML = flashData.map((d,i)=>`<div class="card" onclick="this.classList.toggle('flipped'); cards.add(${i})"><div class="card-inner"><div class="card-front">${d.f}</div><div class="card-back">${d.b}</div></div></div>`).join('');
        if(s==2) document.getElementById('quiz-area').innerHTML = quizData.map((d,i)=>`<div style="margin-bottom:15px"><p><b>${i+1}. ${d.q}</b></p>${d.o.map((o,oi)=>`<label style="display:block; background:#f1f3f9; padding:10px; margin:5px; border-radius:10px; cursor:pointer"><input type="radio" name="q${i}" value="${oi}"> ${o}</label>`).join('')}</div>`).join('');
        if(s==3) {
            let items = matchData.map((d,i)=>`<div class="drag-item" draggable="true" id="d${i}" ondragstart="drag(event)">${d.w}</div>`).join('');
            let zones = matchData.map((d,i)=>`<div class="drop-zone" id="z${i}" ondragover="allowDrop(event)" ondrop="drop(event)">${d.m}</div>`).join('');
            document.getElementById('match-area').innerHTML = items + zones;
        }
    }

    function showFb(step, score, text) {
        const fb = document.getElementById('fb'+step);
        fb.innerHTML = `<h3>Score: ${score}/10</h3><p>${text}</p>`;
        fb.style.display = 'block';
        document.getElementById('next'+step).style.display = 'inline-block';
        confetti();
    }

    function evalFlash() { if(cards.size<8) return alert("Open all 8 cards!"); scores.s1=10; showFb(1,10,"Great curiosity!"); }
    
    function evalQuiz() {
        let r = 0;
        quizData.forEach((d,i)=>{
            let sel = document.querySelector(`input[name="q${i}"]:checked`);
            if(sel && parseInt(sel.value) === d.a) r++;
        });
        scores.s2 = (r/4)*10;
        showFb(2, scores.s2, scores.s2 >= 7 ? "Excellent!" : "Watch the video again.");
    }

    function allowDrop(e) { e.preventDefault(); }
    function drag(e) { e.dataTransfer.setData("text", e.target.id); }
    function drop(e) {
        e.preventDefault();
        let dragId = e.dataTransfer.getData("text");
        if(dragId.replace('d','') === e.target.id.replace('z','')) {
            e.target.classList.add('correct');
            e.target.innerText = "Match!";
            document.getElementById(dragId).style.visibility = 'hidden';
            confetti({particleCount: 20});
        }
    }

    function evalMatch() {
        let ok = document.querySelectorAll('.correct').length;
        scores.s3 = (ok/4)*10;
        showFb(3, scores.s3, "Vocabulary evaluation completed.");
    }

    function evalWriting() {
        let val = document.getElementById('write-text').value.trim();
        let sentences = val.split(/[.!?]/).filter(s => s.length > 5);
        scores.s4 = sentences.length >= 4 ? 10 : sentences.length * 2.5;
        showFb(4, scores.s4, "Writing evaluation done.");
    }

    function startSpeak() {
        let t = 30;
        document.getElementById('spkBtn').disabled = true;
        let count = setInterval(()=>{
            t--;
            document.getElementById('timer').innerText = t;
            if(t<=0) {
                clearInterval(count);
                scores.s5 = 10;
                showFb(5,10,"Speaking completed!");
            }
        },1000);
    }

    function renderFinal() {
        finalAvg = ((scores.s1 + scores.s2 + scores.s3 + scores.s4 + scores.s5) / 5).toFixed(1);
        document.getElementById('final-stats').innerHTML = `<h1>TOTAL AVERAGE: ${finalAvg} / 10</h1>`;
    }

    async function saveToCloud() {
        const name = document.getElementById('stdName').value;
        if(!name) return alert("Write your name!");

        const data = { name: name, score: finalAvg, date: new Date().toLocaleString() };

        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data: [data] })
            });
            if(response.ok) {
                alert("Saved! The teacher now has your grade.");
                toggleCloudList();
            }
        } catch (e) { alert("Connection error."); }
    }

    async function toggleCloudList() {
        const div = document.getElementById('cloud-registry');
        div.style.display = 'block';
        const tbody = document.querySelector('#master-table tbody');
        tbody.innerHTML = '';

        try {
            const res = await fetch(API_URL);
            const data = await res.json();
            document.getElementById('loading-msg').style.display = 'none';
            data.reverse().forEach(row => {
                tbody.innerHTML += `<tr><td>${row.name}</td><td><b>${row.score}</b></td><td>${row.date}</td></tr>`;
            });
        } catch (e) { document.getElementById('loading-msg').innerText = "Error loading list."; }
    }
</script>
</body>
</html>
